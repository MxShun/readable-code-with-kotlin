# 11章 一度に 1 つのことを *One Task at a Time*
コードは 1 つずつタスクを行うようにしなければいけない。 別の言い方をすれば、本章はコードのデフラグについて説明している。

「一度に 1 つのタスクをする」ためにぼくたちが使っている手順

1) コードが行っている「タスク」をすべて列挙する。この「タスク」という言葉はユル句使っている。オブジェクトが妥当かどうかを確認するように小さなこともあれば、ツリーのすべてのノードをいてレートするのように曖昧なこともある。
2) タスクをできるだけ異なる関数に分割する。少なくとも異なる領域に分割する。

### 11.1 タスクは小さくできる *Tasks Can Be Small*
一度に複数のことをするコードは理解しにくい。いろいろなタスクをやることで、エラーやタイポやバグがあっても一目見ただけでは分からない。

一度に 1 つのタスクをするようになれば楽に理解ができ、一目見ただけで正しく動きそうと分かる。

### 11.2 オブジェクトから値を抽出する *Extracting Values from an Object*
ユーザの所在地を読みやすい文字列（「都市、国」）に整形するコードを考える。

| Locality Name | Sub Administrative Area Name | Administrative Area Name | Country Name | *OUTPUT* |
| --- | --- | --- | --- | --- |
| "Santa Monica" | "Los Angeles" | "California" | "USA" | "*Santa Monica, USA*" |

ここまでは簡単だ。ややこしいのは、この 4 つの値のいずれかが（あるいはすべてが）存在しない可能性があることだ。いかに対応策を示す。

- 「都市」を選ぶときには、「Locality Name」（市や町）→「Sub Administrative Area Name」（都市や郡）、「Administrative Area Name」（州や地域）の順番で使用可能なものを使う。
- 以上の 3 つすべてが使えない場合は、「都市」に「Middle-of-Nowhere」（何でもない場所）というデフォルト値を設定する。
- 「国」に「Country Name」（国名）が使えない場合は、「Planet Earth」（地球）というデフォルト値を設定する。

| Locality Name | Sub Administrative Area Name | Administrative Area Name | Country Name | *OUTPUT* |
| --- | --- | --- | --- | --- |
| (undefined) | (undefined) | (undefined) | "Canada" | "*Middle-of-Nowhere, Canada*" |
| (undefined) | "Washington, DC" | (undefined) | "USA" | "*Washington, DC, USA*" |

「一度に 1 つのことを」を適用しないと、ひどいコードになるだろう。

コードをリファクタリングするときには、複数の手法が使えることが多い。

今回も例外ではない。 タスクを分割すると、コードのことを考えやすくなる。その結果、もっとうまくリファクタリングできる方法を思いつく可能性がある。

### 11.3 もっと大きな例 *A Larger Example*
ウェブページをダウンロードしたあとに毎回呼ばれ、さまざまな統計値を更新するウェブクローリングする関数を考える。

1) キーのデフォルト値に「unknown」を使う
2) 必要なメンバがあるかどうかを確認する
3) 値を抽出して文字列に変換する
4) カウンタを更新する

「一度に 1 つのことを」を適用しないと、大量のコードになる。ロジックもいっぱい。重複コードだってある。読んでいて楽しくない。

このコードを改善するには、タスクを目的を持った別々の領域に分割すればよい。

1) 3 つのキーのデフォルト値を定義する
2) 可能であれば、キーの値を抽出して文字列に変換する
3) キーのカウンタを更新する

領域を分けておくといいのは、それぞれが分離されているからだ。ある領域にいるときは、他の領域のことは考えなくて済む。

### 11.4 まとめ *Summary*
コードを構成する簡単な技法「一度に 1 つのタスクを行う」を紹介した。

読みにくいコードがあれば、そこで行われているタスクをすべて列挙する。そこには別の関数やクラスに分割できるタスクがあるだろうか。それ以外は、関数の論理的な「段落」になる。

タスクをどのように分割するかよりも、運渇するということが大切なのだ。
